#!/bin/bash
set -euo pipefail

###~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~##
#
# FUNCTION: Error Handler
#
###~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~##
cleanup() {
  echo "Running clean up"
  ./bin/remove
}
trap cleanup 0

error() {
  local parent_lineno="$1"
  local message="$2"
  local code="${3:-1}"
  if [[ -n "$message" ]] ; then
    echo "Error on or near line ${parent_lineno}: ${message}; exiting with status ${code}"
  else
    echo "Error on or near line ${parent_lineno}; exiting with status ${code}"
  fi
  exit "${code}"
}

trap 'error ${LINENO}' ERR

###~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~##
#
# FUNCTION: Integration Test
#
###~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~##

# echo "Running ci test for stage: $STAGE"
./bin/deploy

echo "Running remove"
./bin/remote

echo "Running migrate"
yarn knex migrate:latest --env "$STAGE"

echo "Running seed"
yarn knex seed:run

STACK_NAME="engstats-$STAGE-$AWS_REGION" # TODO: Get from serverless.yml?
GRAPHQL_URL=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query "Stacks[0].Outputs[?OutputKey=='GraphQLUrl'].OutputValue" --output text)

curl --request POST \
  --url "$GRAPHQL_URL" \
  --header 'content-type: application/json' \
  --data '{"query":"query {\n  users {\n    email\n    first_name\n    last_name\n  }\n}"}'

echo "Clearning up ci test for stage: $STAGE"
./bin/remove
 
echo "Done!"
